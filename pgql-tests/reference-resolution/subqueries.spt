module select

language pgql-lang

test Variable reference in NOT EXISTS #1 [[

  SELECT x.prop AS prop
    FROM g MATCH (x) -> ([[y]])
   WHERE NOT EXISTS ( SELECT x.prop AS prop FROM g MATCH (x) -> ([[z]]) WHERE [[z]] <> [[y]] )

]] resolve #3 to #2
   resolve #4 to #1

test Variable reference in NOT EXISTS #2 [[

  SELECT x.salary AS salary
    FROM g MATCH (x)
   WHERE NOT EXISTS ( SELECT x.salary AS salary FROM g MATCH ([[x]]) -> ([[y]]) WHERE [[x]].salary = [[y]].salary )

]] resolve #3 to #1
   resolve #4 to #2

test Reference select key from outer query (1) [[

    SELECT n.age AS [[nAge]]
      FROM g MATCH (n)
   ORDER BY ( SELECT [[nAge]] AS x FROM g MATCH (n) LIMIT 1 )

]] resolve #2 to #1

test Reference select key from outer query (2) [[

    SELECT n.age AS [[nAge]]
      FROM g MATCH (n)
   ORDER BY ( SELECT AVG([[nAge]]) AS avg FROM g MATCH (n) GROUP BY n LIMIT 1 )

]] resolve #2 to #1

test Reference select key from outer query (3) [[

    SELECT n.age AS [[nAge]]
      FROM g MATCH (n)
  GROUP BY n.age AS nAge
  ORDER BY ( SELECT AVG([[nAge]]) AS avg FROM g MATCH (n) GROUP BY n LIMIT 1 )

]] resolve #2 to #1

test Reference vertices from both inner and outer query inside aggregation [[

  SELECT id([[a]]) AS id, (SELECT COUNT([[a]].prop + [[b]].prop) AS cnt1 FROM g MATCH ([[b]])) AS cnt2
    FROM g MATCH ([[a]])

]] resolve #1 to #5
   resolve #2 to #5
   resolve #3 to #4

test Reference group key from outer query (1) [[

    SELECT 123 AS x
      FROM g MATCH (n)
    GROUP BY n.age AS [[nAge]]
   ORDER BY ( SELECT AVG([[nAge]]) AS avg FROM g MATCH (n) LIMIT 1 )

]] resolve #2 to #1

test Reference group key from outer query (2) [[

    SELECT 123 AS x
      FROM g MATCH (n)
  GROUP BY n.age AS [[nAge]]
  ORDER BY ( SELECT AVG([[nAge]]) AS avg FROM g MATCH (n) GROUP BY n LIMIT 1 )

]] resolve #2 to #1

test No implicit expression replacement between inner and outer query [[

    SELECT n.prop AS prop
      FROM g MATCH ([[n]])
  ORDER BY ( SELECT [[n]].prop AS prop MATCH (m) )

]] resolve #2 to #1 // tests that the expression in the SELECT of the inner query was not replaced by a reference to the alias in the SELECT of the outer query (GM-17397).
